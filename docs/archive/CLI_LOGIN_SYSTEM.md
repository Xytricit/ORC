# CLI Login System - Complete

## Overview

The ORC CLI now requires authentication with the web interface before use. All data is interconnected between CLI and web.

---

## What Changed

### 1. Authentication Required
- CLI now checks for authentication on startup
- Shows login prompt if not authenticated
- All main commands require login

### 2. New Commands

**Login Command:**
```bash
orc login
# Interactive prompt for token

orc login --token YOUR_TOKEN
# Direct login with token

orc login --url http://your-server:5000
# Custom server URL
```

**Logout Command:**
```bash
orc logout
# Signs out and removes token
```

**Status Command:**
```bash
orc status
# Shows authentication status
# Shows web URL and default AI provider
```

### 3. Configuration Storage
- Token stored in `~/.orc/config.json`
- Secure local storage
- Persists between sessions

### 4. Commands Requiring Auth
All main commands now require authentication:
- `orc index` - Index codebase
- `orc dead` - Find dead code
- `orc deps` - Show dependencies
- `orc metrics` - Show metrics
- `orc complexity` - Complexity analysis
- `orc chat` - AI chat (already had auth)

---

## User Flow

### First Time Setup:

1. **Start web server:**
```bash
python orc/web/app_new.py
```

2. **Create account:**
   - Visit http://127.0.0.1:5000/
   - Click "Get Started Free"
   - Create account

3. **Configure AI provider:**
   - Go to Settings > API Config
   - Add Groq, OpenAI, or other provider
   - Set as default

4. **Generate CLI token:**
   - Go to Settings > Account
   - Click "Generate Token"
   - Copy token

5. **Login to CLI:**
```bash
orc login
# Paste token when prompted
```

6. **Use CLI:**
```bash
orc index .
orc dead
orc chat
# All commands now work!
```

---

## What Happens Without Login

When user tries to run a command without authentication:

```
╭─ Authentication Required ─╮
│                           │
│ You need to sign in to    │
│ use ORC CLI               │
│                           │
│ ORC CLI now requires      │
│ authentication with the   │
│ web interface.            │
│                           │
│ This allows you to:       │
│   • Manage API keys       │
│   • Sync projects         │
│   • Access data from CLI  │
│     and web               │
│                           │
│ Run: orc login            │
│                           │
╰───────────────────────────╯
```

---

## Benefits

### For Users:
1. **Single Sign-On**: One account for CLI and web
2. **Centralized Config**: Manage API keys in one place
3. **Data Sync**: Projects and analyses synced
4. **Better UX**: Visual web interface for setup
5. **Security**: Tokens can be revoked

### For System:
1. **Interconnected**: All data in one database
2. **User Tracking**: Know who's using what
3. **Better Support**: Can help users via web
4. **Analytics**: Usage statistics
5. **Monetization Ready**: Can add paid tiers

---

## Technical Details

### Authentication Flow:
1. CLI checks for `~/.orc/config.json`
2. If not found, shows login prompt
3. User runs `orc login`
4. CLI prompts for token
5. Tests token with API call to `/api/configs`
6. If valid, saves to config file
7. All future commands use this token

### Token Format:
- 64 character secure random string
- Generated by `secrets.token_urlsafe(48)`
- Stored in database: `cli_tokens` table
- Includes user_id, created_at, last_used

### API Integration:
- All API calls include `X-CLI-Token` header
- Token validated on each request
- Last used timestamp updated
- User info cached in CLI

---

## Configuration File

`~/.orc/config.json`:
```json
{
  "web_url": "http://127.0.0.1:5000",
  "web_token": "your_secure_token_here"
}
```

---

## Testing

### Test Authentication:
```bash
# Check status (should show not authenticated)
orc status

# Try command without auth (should fail)
orc index .

# Login
orc login

# Check status (should show authenticated)
orc status

# Now commands work
orc index .
orc dead

# Logout
orc logout

# Status should show not authenticated again
orc status
```

---

## Error Handling

### Token Expired/Invalid:
```
╭─ Re-authentication Required ─╮
│                               │
│ Your session has expired or   │
│ is invalid                    │
│                               │
│ Run: orc login                │
│                               │
╰───────────────────────────────╯
```

### Web Server Not Running:
```
Cannot connect to http://127.0.0.1:5000

Make sure the web server is running:
  python orc/web/app_new.py
```

---

## Security Features

1. **Token Protection**: Stored locally, not transmitted except in headers
2. **HTTPS Ready**: Works with HTTPS URLs
3. **Token Revocation**: Generate new token to invalidate old ones
4. **Secure Storage**: Config file permissions should be 600
5. **No Password Storage**: Only token, never password

---

## Future Enhancements

1. **Auto Refresh**: Auto-refresh expired tokens
2. **Multiple Profiles**: Switch between accounts
3. **Team Collaboration**: Share projects with team
4. **Offline Mode**: Cache data for offline use
5. **Two-Factor Auth**: Add 2FA to web login

---

## Migration Notes

### For Existing Users:
- Old `.env` files still work as fallback
- Can still use `GROQ_API_KEY` env vars
- Priority: Web config > Env vars > .env file
- Gradual migration encouraged

### Backward Compatibility:
- Commands still accept `--api-key` flags
- Can bypass web login with explicit keys
- But web login is recommended

---

## Commands Summary

```bash
# Authentication
orc login                    # Interactive login
orc login --token TOKEN      # Direct login
orc logout                   # Sign out
orc status                   # Check auth status

# Analysis (all require auth)
orc index .                  # Index codebase
orc dead                     # Find dead code
orc deps                     # Show dependencies
orc metrics                  # Show metrics
orc complexity               # Complexity analysis
orc chat                     # AI chat

# Version & Help
orc --version               # Show version
orc --help                  # Show help
```

---

## Status

**Implementation:** Complete
**Testing:** Ready
**Documentation:** Complete
**Status:** PRODUCTION READY

---

The CLI now requires web authentication, making CLI and web fully interconnected with centralized data and configuration management.
